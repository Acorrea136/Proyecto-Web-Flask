{% include 'sitio/header.html' %}

<div class="container py-5">
    <h2 class="display-4 mb-5 text-center fw-bold text-dark">Sistema de Citas</h2>
    <div class="row g-4">
        <!-- Calendario de Citas -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-body p-0">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
        
        <!-- Lista de Citas del Usuario -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-lg rounded-4">
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="card-title mb-0 fw-bold">Mis Citas Programadas</h5>
                </div>
                <div class="card-body">
                    {% if citas_usuario %}
                        <div class="citas-list">
                            {% for cita in citas_usuario %}
                                <div class="appointment-card mb-3 p-3 bg-light rounded-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="text-dark fw-bold mb-2">
                                                {{ cita.fecha.strftime('%d de %B, %Y') }}
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-clock me-2 text-muted"></i>
                                                <span>{{ cita.hora.strftime('%H:%M') }}</span>
                                            </div>
                                        </div>
                                        <button 
                                            onclick="if(confirm('¿Estás seguro de cancelar esta cita?')) window.location.href='/sitio/cancelar_cita/{{ cita.fecha.strftime('%Y-%m-%d') }}/{{ cita.hora.strftime('%H:%M:%S') }}'"
                                            class="btn btn-outline-danger btn-sm rounded-pill">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No tienes citas programadas.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agendar cita -->
<div class="modal fade" id="agendarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">Agendar Nueva Cita</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/sitio/agendar_cita" method="post">
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label fw-bold">Fecha seleccionada</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-calendar-alt"></i>
                            </span>
                            <input type="text" class="form-control" id="fecha" name="fecha" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Horario disponible</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-clock"></i>
                            </span>
                            <select class="form-select" id="hora" name="hora" required>
                                <!-- Las opciones se llenarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-dark rounded-pill px-4">
                        <i class="fas fa-check me-2"></i>Confirmar Cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Librerías necesarias -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
:root {
    --fc-border-color: #e5e7eb;
    --fc-button-hover-bg-color: #1f2937;
    --fc-button-hover-border-color: #1f2937;
    --fc-button-active-bg-color: #1f2937;
    --fc-button-active-border-color: #1f2937;
}

#calendar {
    font-family: 'Inter', sans-serif;
}

/* Modified toolbar styling */
.fc .fc-toolbar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
}

.fc .fc-toolbar-title {
    font-size: 1.5rem;
    font-weight: 600;
    text-align: center;
    width: 100%;
    order: -1; /* Move title to top */
}

/* Center the button groups */
.fc .fc-toolbar-chunk {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
}

/* Hide the right section buttons (month/week view) */
.fc .fc-toolbar-chunk:last-child {
    display: none;
}

/* Center the navigation buttons */
.fc .fc-toolbar-chunk:first-child {
    width: 100%;
    justify-content: center;
    gap: 1rem;
}

.fc .fc-button {
    border-radius: 50px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.2s;
    min-width: 100px; /* Ensure consistent button width */
}

.fc .fc-button-primary {
    background-color: #111827;
    border-color: #111827;
}

.fc .fc-button-primary:not(:disabled):active,
.fc .fc-button-primary:not(:disabled).fc-button-active {
    background-color: #1f2937;
    border-color: #1f2937;
}

.fc-theme-standard td {
    border: 1px solid var(--fc-border-color);
}

.fc .fc-daygrid-day.fc-day-today {
    background-color: #f3f4f6 !important;
}

.fc-daygrid-event {
    border-radius: 50px !important;
    padding: 2px 8px !important;
}

.fc-h-event {
    background-color: #374151 !important;
    border-color: #374151 !important;
}

.appointment-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.appointment-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
}

.modal-content {
    border: none;
}

.input-group-text {
    border: none;
}

.form-control, .form-select {
    border: 1px solid #e5e7eb;
    padding: 0.625rem 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: #111827;
    box-shadow: 0 0 0 0.25rem rgb(17 24 39 / 25%);
}

.btn-dark {
    background-color: #111827;
    border-color: #111827;
}

.btn-dark:hover {
    background-color: #1f2937;
    border-color: #1f2937;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const calendarEl = document.getElementById('calendar');
        if (!calendarEl) {
            console.error('Elemento del calendario no encontrado');
            return;
        }

        const citasRegistradas = [
            {% for cita in citas %}
                {
                    fecha: '{{ cita.fecha.strftime("%Y-%m-%d") }}',
                    hora: '{{ cita.hora.strftime("%H:%M:%S") }}'
                },
            {% endfor %}
        ];

        // Definir todos los horarios disponibles
        const horariosDisponibles = [
            '08:00:00', '09:00:00', '10:00:00', '11:00:00',
            '12:00:00', '13:00:00', '14:00:00', '15:00:00'
        ];

        // Función para obtener horarios ocupados en una fecha específica
        function getHorariosOcupados(fecha) {
            return citasRegistradas
                .filter(cita => cita.fecha === fecha)
                .map(cita => cita.hora);
        }

        // Función para actualizar las opciones de horarios disponibles
        function actualizarHorariosDisponibles(fecha) {
            const horariosOcupados = getHorariosOcupados(fecha);
            const selectHora = document.getElementById('hora');
            selectHora.innerHTML = ''; // Limpiar opciones existentes

            horariosDisponibles.forEach(hora => {
                if (!horariosOcupados.includes(hora)) {
                    const option = document.createElement('option');
                    option.value = hora;
                    const horaFormateada = new Date(`2000-01-01T${hora}`).toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    option.textContent = horaFormateada;
                    selectHora.appendChild(option);
                }
            });

            // Deshabilitar el botón de submit si no hay horarios disponibles
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.disabled = selectHora.options.length === 0;
        }

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            timeZone: 'local',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next,today',
                center: 'title',
                right: '' // Remove right section buttons
            },
            buttonText: {
                today: 'Hoy',
                prev: 'Anterior',
                next: 'Siguiente'
            },
            events: citasRegistradas.map(cita => ({
                title: 'Reservado',
                start: `${cita.fecha}T${cita.hora}`,
                allDay: false,
                backgroundColor: '#374151',
                borderColor: '#374151',
                textColor: 'white'
            })),
            dateClick: function(info) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(info.date);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    alert('No se pueden agendar citas en fechas pasadas.');
                    return;
                }

                const fechaSeleccionada = info.dateStr;
                const horariosOcupados = getHorariosOcupados(fechaSeleccionada);
                
                if (horariosOcupados.length >= horariosDisponibles.length) {
                    alert('No hay horarios disponibles para este día.');
                    return;
                }

                document.getElementById('fecha').value = fechaSeleccionada;
                actualizarHorariosDisponibles(fechaSeleccionada);
                const modal = new bootstrap.Modal(document.getElementById('agendarModal'));
                modal.show();
            },
            eventClick: function(info) {
                alert('Este horario ya está reservado.');
            }
        });

        calendar.render();
        console.log('Calendario renderizado exitosamente');
    } catch (error) {
        console.error('Error al inicializar el calendario:', error);
    }
});
</script>

{% include 'sitio/footer.html' %}